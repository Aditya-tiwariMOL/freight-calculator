<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Outstanding Receivables</title>

<style>
:root {
  --mol-blue: #1f4ea3;
  --bg: #f4f6fb;
  --card: #ffffff;
  --success: #1a7f37;
}

/* ================= BASE ================= */
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: var(--bg);
}

/* ================= HEADER ================= */
h1 {
  text-align: center;
  color: var(--mol-blue);
  margin: 18px 0 6px;
}

.summary {
  text-align: center;
  margin-bottom: 16px;
}

.summary .amount {
  font-size: 22px;
  font-weight: bold;
}

.summary .date {
  font-size: 12px;
  color: #555;
}

/* ================= TABLE ================= */
.table-wrapper {
  overflow-x: auto;
  padding: 0 12px 40px;
}

.row {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr 1fr;
  gap: 8px;
  padding: 12px;               /* +20% height */
  align-items: center;
  min-width: 900px;
  font-size: 18px;             /* +30% desktop */
  line-height: 1.4;
  background: #fff;
}

.header {
  background: var(--mol-blue);
  color: #fff;
  font-weight: bold;
  border-radius: 6px;
}

.card {
  background: var(--card);
  border-radius: 6px;
  margin-top: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.customer {
  background: #eef3ff;
}

.invoice {
  padding-left: 28px;
  font-size: 16px;
}

.hidden {
  display: none;
}

/* ================= INPUT ================= */
input {
  width: 100%;
  padding: 6px;
  font-size: 16px;
  box-sizing: border-box;
}

.save-indicator {
  font-size: 12px;
  color: var(--success);
  margin-top: 4px;
  display: none;
}

/* ================= TOAST ================= */
.toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--mol-blue);
  color: #fff;
  padding: 10px 18px;
  border-radius: 20px;
  display: none;
}

/* ================= MOBILE ================= */
@media (max-width: 768px) {

  .row {
    font-size: 15px;            /* +15% mobile */
    padding: 14px 10px;         /* +20% height */
    min-width: 760px;
  }

  /* Wrap name after ~3 words */
  .row > div:first-child {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  input {
    font-size: 15px;
  }
}
</style>
</head>

<body>

<h1>Outstanding Receivables</h1>

<div class="summary">
  <div class="amount" id="netOutstanding">—</div>
  <div class="date" id="lastUpdated">Last updated: —</div>
</div>

<div class="table-wrapper">
  <div class="row header">
    <div>Name</div>
    <div>Total</div>
    <div>On Account</div>
    <div>90+</div>
    <div>60–90</div>
    <div>30–60</div>
    <div>Forecast</div>
  </div>

  <div id="app"></div>
</div>

<div class="toast" id="toast">Forecast updated</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzmQV1ULJx-CZyqWanibqRuj5UV5qSmChaTFoCzIrNUBIRF9ST6tVr1JQ8w-GxdR1oB/exec";

let openPIC = null;
let openCustomer = null;
const isMobile = window.innerWidth <= 768;

fetch(API_URL)
  .then(res => res.json())
  .then(data => {
    render(data);
    updateSummary(data);
  });

function formatNumber(val) {
  if (!isMobile) return val.toLocaleString();
  if (val >= 1000) return Math.round(val / 1000) + "K";
  return val;
}

function updateSummary(data) {
  let totalOutstanding = 0;
  let totalOnAccount = 0;

  data.forEach(p => {
    totalOutstanding += sum(p.totals);
    Object.values(p.customers).forEach(c => {
      totalOnAccount += c.onAccount || 0;
    });
  });

  document.getElementById("netOutstanding").innerText =
    "Net Outstanding: ₹" + formatNumber(totalOutstanding - totalOnAccount);

  document.getElementById("lastUpdated").innerText =
    "Last refreshed: " + new Date().toLocaleString();
}

function render(data) {
  const app = document.getElementById("app");
  app.innerHTML = "";

  data.forEach(pic => {
    const card = document.createElement("div");
    card.className = "card";

    const picRow = createPICRow(pic);
    const customerContainer = document.createElement("div");
    customerContainer.className = "hidden";

    picRow.onclick = () => toggle(customerContainer, "pic");

    Object.values(pic.customers).forEach(c => {
      const customerRow = createCustomerRow(pic.salesPIC, c);
      const invoiceContainer = document.createElement("div");
      invoiceContainer.className = "hidden";

      customerRow.onclick = () => toggle(invoiceContainer, "customer");

      c.invoices.forEach(i => {
        const inv = document.createElement("div");
        inv.className = "row invoice";
        inv.innerHTML = `
          <div>${i.invoiceNo}</div>
          <div>${formatNumber(i.total)}</div>
          <div></div>
          <div>${formatNumber(i.ageing["90+"] || 0)}</div>
          <div>${formatNumber(i.ageing["61-90"] || 0)}</div>
          <div>${formatNumber(i.ageing["31-60"] || 0)}</div>
          <div></div>
        `;
        invoiceContainer.appendChild(inv);
      });

      customerContainer.appendChild(customerRow);
      customerContainer.appendChild(invoiceContainer);
    });

    card.appendChild(picRow);
    card.appendChild(customerContainer);
    app.appendChild(card);
  });
}

function createPICRow(pic) {
  const row = document.createElement("div");
  row.className = "row";
  row.innerHTML = `
    <div>${pic.salesPIC}</div>
    <div>${formatNumber(sum(pic.totals))}</div>
    <div></div>
    <div>${formatNumber(pic.totals["90+"] || 0)}</div>
    <div>${formatNumber(pic.totals["61-90"] || 0)}</div>
    <div>${formatNumber(pic.totals["31-60"] || 0)}</div>
    <div></div>
  `;
  return row;
}

function createCustomerRow(picName, c) {
  const row = document.createElement("div");
  row.className = "row customer";

  const saveMsg = document.createElement("div");
  saveMsg.className = "save-indicator";
  saveMsg.innerText = "✔ Saved";

  row.innerHTML = `
    <div>${c.customerName}</div>
    <div>${formatNumber(sum(c.totals))}</div>
    <div>${formatNumber(c.onAccount || 0)}</div>
    <div>${formatNumber(c.totals["90+"] || 0)}</div>
    <div>${formatNumber(c.totals["61-90"] || 0)}</div>
    <div>${formatNumber(c.totals["31-60"] || 0)}</div>
    <div>
      <input type="number"
        value="${c.forecast || ""}"
        onclick="event.stopPropagation()"
        onchange="saveForecast('${picName}','${c.customerName}',this.value,this)">
    </div>
  `;

  row.querySelector("div:last-child").appendChild(saveMsg);
  return row;
}

function sum(t) {
  return (t["90+"] || 0) + (t["61-90"] || 0) + (t["31-60"] || 0) + (t["1-30"] || 0);
}

function toggle(el, level) {
  if (level === "pic" && openPIC && openPIC !== el) openPIC.classList.add("hidden");
  if (level === "customer" && openCustomer && openCustomer !== el) openCustomer.classList.add("hidden");

  el.classList.toggle("hidden");

  if (level === "pic") openPIC = el.classList.contains("hidden") ? null : el;
  if (level === "customer") openCustomer = el.classList.contains("hidden") ? null : el;
}

function saveForecast(pic, customer, value, inputEl) {
  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "updateForecast",
      salesPIC: pic,
      customer: customer,
      forecast: Number(value)
    })
  }).then(() => {
    showToast();
    const msg = inputEl.parentElement.querySelector(".save-indicator");
    msg.style.display = "block";
    setTimeout(() => msg.style.display = "none", 2000);
  });
}

function showToast() {
  const t = document.getElementById("toast");
  t.style.display = "block";
  setTimeout(() => t.style.display = "none", 2000);
}
</script>

</body>
</html>
