<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Freight Calculator</title>

<style>
*,
*::before,
*::after { box-sizing:border-box; }

body {
  margin:0;
  font-family:Arial, sans-serif;
  background:#f4f4f4;
  padding:20px;
}

.card {
  background:white;
  max-width:900px;
  margin:0 auto;
  padding:20px;
  border-radius:14px;
  box-shadow:0 4px 20px rgba(0,0,0,0.12);
}

.logo-text {
  text-align:center;
  font-size:17px;
  font-weight:900;
  color:#164A9D;
}

h2 {
  text-align:center;
  font-size:19px;
  margin:10px 0 20px;
}

.input-box {
  background:#fafafa;
  border-radius:12px;
  padding:15px;
  max-width:450px;
  margin:0 auto;
}

label {
  margin-top:15px;
  font-weight:bold;
  font-size:15px; /* +1px */
}

input, select {
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:16px; /* +1px */
}

.suggestion-box {
  display:none;
  position:absolute;
  background:white;
  border:1px solid #ccc;
  border-radius:8px;
  width:100%;
  max-height:180px;
  overflow-y:auto;
  z-index:50;
}

.suggestion-box div {
  padding:10px;
  cursor:pointer;
  font-size:16px; /* +1px */
}

.suggestion-box div:hover {
  background:#eaf4ff;
}

.loader {
  display:none;
  justify-content:center;
  margin-top:25px;
}

.loader::after {
  content:"";
  width:50px;
  height:50px;
  border:6px solid #e3e3e3;
  border-top-color:#1E74F0;
  border-radius:50%;
  animation:spin 0.9s linear infinite;
}

@keyframes spin { to { transform:rotate(360deg); } }

.result-wrapper {
  display:none;
  margin-top:25px;
  background:#f7fbff;
  padding:15px;
  border-radius:12px;
}
</style>
</head>

<body>
<div class="card">

<div style="text-align:center;margin-bottom:10px;">
  <img src="https://raw.githubusercontent.com/Aditya-tiwariMOL/freight-calculator/main/MOL%20Logo%2001.png" style="height:35px;">
  <div class="logo-text">MOL Logistics (INDIA) PVT. LTD.</div>
</div>

<h2>Freight Calculator</h2>

<div class="input-box">

<label>POL</label>
<div style="position:relative;">
  <input id="polInput" placeholder="Type POL">
  <div id="polList" class="suggestion-box"></div>
</div>

<label>POD</label>
<div style="position:relative;">
  <input id="podInput" placeholder="Type POD">
  <div id="podList" class="suggestion-box"></div>
</div>

<label>Container</label>
<select id="container">
  <option value="">Select Container</option>
  <option>20GP</option>
  <option>40GP</option>
  <option>40GP/HC</option>
</select>

</div>

<div class="loader" id="loader"></div>

<div class="result-wrapper" id="resultBox">
  <table width="100%">
    <thead>
      <tr>
        <th>Line</th><th>Freight</th><th>BAF</th><th>Sur.</th>
        <th>Local</th><th>Total</th><th>Remark</th><th>Route</th><th>Validity</th>
      </tr>
    </thead>
    <tbody id="resultBody"></tbody>
  </table>
</div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxvRp16ShsJ0CHyzVC7TnuensTPsZSaXq4cbbqIfSeYx2xCNkNh4LDYrTf8BTR5x1Cq/exec";

const polInput = document.getElementById("polInput");
const podInput = document.getElementById("podInput");
const container = document.getElementById("container");
const polList = document.getElementById("polList");
const podList = document.getElementById("podList");
const loader = document.getElementById("loader");
const resultBox = document.getElementById("resultBox");
const resultBody = document.getElementById("resultBody");

/* ---------- FUZZY MATCH ---------- */
function normalize(s) {
  return s.toLowerCase().replace(/[^a-z0-9]/g,"");
}

function fuzzySort(items, input) {
  const nInput = normalize(input);

  return items
    .map(item => {
      const nItem = normalize(item);
      let score = 0;

      if (nItem === nInput) score += 100;
      else if (nItem.startsWith(nInput)) score += 70;
      else if (nItem.includes(nInput)) score += 40;

      // loose character match
      let matchCount = 0;
      for (let c of nInput) {
        if (nItem.includes(c)) matchCount++;
      }
      score += matchCount;

      return { item, score };
    })
    .filter(x => x.score > 0)
    .sort((a,b) => b.score - a.score)
    .map(x => x.item);
}

/* ---------- TYPEAHEAD ---------- */
function setupTypeAhead(input, box, items) {
  input.oninput = () => {
    const val = input.value.trim();
    if (!val) return box.style.display="none";

    const matches = fuzzySort(items, val);
    if (!matches.length) return box.style.display="none";

    box.innerHTML = matches.map(x => `<div>${x}</div>`).join("");
    box.style.display="block";

    box.querySelectorAll("div").forEach(d => {
      d.onmousedown = () => {
        input.value = d.textContent;
        box.style.display="none";
        input.dispatchEvent(new Event("change"));
      };
    });
  };

  input.onblur = () => setTimeout(()=>box.style.display="none",150);
}

/* LOAD POL */
(async()=>{
  const pols = await fetch(API_URL+"?action=pol").then(r=>r.json());
  setupTypeAhead(polInput, polList, pols);
})();

/* LOAD POD */
polInput.onchange = async () => {
  podInput.value="";
  container.value="";
  resultBox.style.display="none";

  const pods = await fetch(API_URL+"?action=pod&pol="+encodeURIComponent(polInput.value))
    .then(r=>r.json());

  setupTypeAhead(podInput, podList, pods);

  if (podInput.value) podInput.dispatchEvent(new Event("input"));
};

/* FINAL RESULT */
container.onchange = async () => {
  if (!container.value) return;

  loader.style.display="flex";
  resultBox.style.display="none";

  const rows = await fetch(
    API_URL+"?action=rates"+
    "&pol="+encodeURIComponent(polInput.value)+
    "&pod="+encodeURIComponent(podInput.value)+
    "&container="+encodeURIComponent(container.value)
  ).then(r=>r.json());

  loader.style.display="none";
  if (!rows.length) return;

  resultBody.innerHTML = rows.map(r=>`
    <tr>
      <td>${r.carrier}</td>
      <td>${r.freight}</td>
      <td>${r.obs}</td>
      <td>${r.surcharges}</td>
      <td>${r.local}</td>
      <td>${r.total}</td>
      <td>${r.remark}</td>
      <td>${r.routing}</td>
      <td>${r.validity}</td>
    </tr>`).join("");

  resultBox.style.display="block";
};
</script>

</body>
</html>
